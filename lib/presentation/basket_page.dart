import 'package:flutter/material.dart';import 'package:flutter_bloc/flutter_bloc.dart';import 'package:google_fonts/google_fonts.dart';import '../bloc/basket/basket_bloc.dart';import '../data/api/products/product.dart';import '../data/local/hive_helper.dart';import 'components/basket.dart';class BasketPage extends StatefulWidget {  const BasketPage({Key? key}) : super(key: key);  @override  State<BasketPage> createState() => _BasketPageState();}class _BasketPageState extends State<BasketPage> {  final _bloc = BasketBloc();  List<ProductData> data = [];  @override  void initState() {    _bloc.add(GetAllProductsFromBasketEvent());    super.initState();  }  String calculateTotalSum(List<ProductData> products) {    int totalSum = 0;    for (var product in products) {      totalSum += product.count * int.parse(product.price);      // totalSum += (double.tryParse(product.value) ?? 0) * (double.tryParse(product.price) ?? 0);    }    return totalSum.toString();  }  @override  Widget build(BuildContext context) {    return BlocProvider.value(      value: _bloc,      child: BlocConsumer<BasketBloc, BasketState>(        listener: (context, state) {          if (state is GetAllProductsFromBasketState) {            setState(() {              data = List.from(state.data);            });          }        },        builder: (context, state) {          return Scaffold(            appBar: AppBar(              toolbarHeight: 70,              backgroundColor: const Color(0xFFFFC300),              shadowColor: Theme.of(context).colorScheme.shadow,              shape: const RoundedRectangleBorder(                borderRadius: BorderRadius.vertical(                  bottom: Radius.circular(10),                ),              ),              title:  Column(                children: [                  // Image.asset(                  //   "assets/images/img.png",                  //   width: 170,                  //   height: 30,                  //   fit: BoxFit.cover,                  // ),                  SizedBox(width: 120,),                  Text("Savatcha", style: TextStyle(fontSize: 25, fontWeight: FontWeight.w700),)                ],              ),            ),            body: SafeArea(              child: Column(                children: [                  Expanded(                    child: Padding(                      padding: const EdgeInsets.all(10),                      child: Builder(                        builder: (context) {                          if (state is GetAllProductsFromBasketState) {                            return ListView.builder(                              itemCount: data.length,                              itemBuilder: (context, index) {                                if (state.data[index].count == 0) {                                  // setState(() {                                  state.data[index].count = 1;                                  // });                                }                                bool isSaved =                                HiveHelper.getAllKeysProductsFromFavourite()                                    .contains(state.data[index].id);                                // setState(() {                                state.data[index].isSaved = isSaved;                                return BasketItem(                                  product: data[index],                                  // Внутри _BasketPageState                                  onDelete: (){                                    setState(() {                                      _bloc.add(DeleteProductFromBasketEvent(product: state.data[index]));                                    });                                  } ,                                  addToFav:   () {                                      setState(() {                                        _bloc.add(AddProductToFavourite(product: state.data[index]));                                      });                                  },                                );                              },                            );                          } else {                            return const Center(                              child: CircularProgressIndicator(),                            );                          }                        },                      ),                    ),                  ),                  const SizedBox(height: 10),                    Row(                    mainAxisAlignment: MainAxisAlignment.spaceBetween,                    children: [                      const Padding(                        padding: EdgeInsets.only(left: 12.0),                        child: Text(                          "Barchasi:",                          style: TextStyle(                            fontWeight: FontWeight.w700,                            fontSize: 20,                          ),                        ),                      ),                      Padding(                        padding: EdgeInsets.only(right: 8.0),                        child: Text(                          // Calculate and display the total sum of products                          calculateTotalSum(data),                          style: const TextStyle(                            fontWeight: FontWeight.w500,                            fontSize: 15,                            color: Colors.black,                          ),                        ),                      ),                    ],                  ),                  Container(                    height: 50,                    width: MediaQuery.of(context).size.width,                    decoration: ShapeDecoration(                      color: const Color(0xFFffc300),                      shape: RoundedRectangleBorder(                        borderRadius: BorderRadius.circular(10),                      ),                    ),                    child: Padding(                      padding: const EdgeInsets.symmetric(vertical: 15),                      child: InkWell(                        onTap: () async {                        },                        child: Text(                          'Buyurtma qilish',                          textAlign: TextAlign.center,                          style: GoogleFonts.roboto(                            color: Colors.black,                            fontSize: 18,                            fontWeight: FontWeight.w400,                            height: 0,                          ),                        ),                      ),                    ),                  ),                  SizedBox(height: 10),                  Container(                    width: MediaQuery.of(context).size.width,                    decoration: ShapeDecoration(                      color: Colors.black,                      shape: RoundedRectangleBorder(                        borderRadius: BorderRadius.circular(10),                      ),                    ),                    child: Padding(                      padding: const EdgeInsets.symmetric(vertical: 15),                      child: InkWell(                        onTap: ()  {                          setState(() {                            _bloc.add(DeleteBasket());                          });                        },                        child: Text(                          'Tozalash',                          textAlign: TextAlign.center,                          style: GoogleFonts.roboto(                            color: Colors.white,                            fontSize: 18,                            fontWeight: FontWeight.w400,                            height: 0,                          ),                        ),                      ),                    ),                  ),                ],              ),            ),          );        },      ),    );}}